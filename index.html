<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∏ Gi·∫£i Ao L√†ng üè∏-</title>
    <style>
        :root { --p: #667eea; --s: #764ba2; --success: #28a745; --gold: #FFD700; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; text-align: center; }
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #666; font-size: 0.85em; border: none; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        
        /* RANK GROUPS */
        @keyframes legendGlow { 0%, 100% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 20px #ff0000; } }
        @keyframes gmGlow { 0%, 100% { box-shadow: 0 0 5px #ff1493; } 50% { box-shadow: 0 0 15px #ff1493; } }
        .rank-group { margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: #fff; border: 1px solid #eee; }
        .group-legend { border: 2px solid #ff0000; animation: legendGlow 2s infinite; }
        .group-grandmaster { border: 2px solid #ff1493; animation: gmGlow 2s infinite; }
        .rank-group-header { padding: 10px 15px; font-weight: bold; color: white; display: flex; justify-content: space-between; text-transform: uppercase; font-size: 0.75em; }
        .bg-legend { background: linear-gradient(90deg, #b30000, #ff0000, #b30000); }
        .bg-grandmaster { background: linear-gradient(90deg, #8B008B, #FF1493); }
        .bg-master { background: linear-gradient(90deg, #4B0082, #9370DB); }
        .bg-diamond { background: linear-gradient(90deg, #104E8B, #1E90FF); }
        .bg-platinum { background: linear-gradient(90deg, #2F4F4F, #4A9EAF); }
        .bg-gold { background: #daa520; }
        .player-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 15px; 
            border-bottom: 1px solid #f0f0f0; 
            align-items: center; 
        }
        
        /* ‚úÖ FIX: Container cho t√™n v√† button */
        .player-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .player-name {
            min-width: 100px;
        }
        
        /* ‚úÖ FIX: Button width c·ªë ƒë·ªãnh - GI·ªÆ TEXT */
        .view-ach-btn { 
            background: none; 
            border: 1px solid var(--p); 
            color: var(--p); 
            padding: 6px 12px; 
            border-radius: 6px; 
            font-size: 0.7em; 
            cursor: pointer; 
            font-weight: bold;
            white-space: nowrap;
            width: 95px; /* ‚Üê WIDTH C·ªê ƒê·ªäNH ƒê·ªÇ CH·ª®A "üèÜ Th√†nh t·ª±u" */
            text-align: center;
        }
        
        .player-elo {
            color: var(--p);
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }
        
        /* MODAL */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; padding: 10px; }
        .modal-content { background: white; max-width: 600px; margin: 20px auto; border-radius: 20px; padding: 20px; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 15px; font-size: 30px; cursor: pointer; color: #999; }
        .bar-container { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: 1s; }
        .ach-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 10px; }
        .ach-card { background: #fff; border: 1px solid #eee; padding: 12px 8px; border-radius: 12px; text-align: center; opacity: 0.3; filter: grayscale(1); transition: all 0.3s; }
        .ach-card:hover { transform: scale(1.05); }
        .ach-card.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--gold); }
        .ach-card.unlocked:hover { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .ach-icon { font-size: 1.8em; }
        .ach-name { font-size: 0.75em; font-weight: bold; display: block; margin-top: 5px; }
        .ach-desc { font-size: 0.65em; color: #666; display: block; margin-top: 3px; line-height: 1.2; }
        
        /* HISTORY */
        .history-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--p); }
        .hist-date { font-size: 0.75em; color: #888; font-weight: bold; margin-bottom: 5px; }
        .hist-type { font-size: 0.7em; background: #eee; padding: 2px 8px; border-radius: 4px; color: #555; text-transform: uppercase; margin-bottom: 8px; display: inline-block; }
        .hist-players { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 5px; }
        .team-name { flex: 1; font-size: 0.9em; font-weight: 600; }
        .hist-score { background: var(--p); color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; min-width: 60px; text-align: center; }
        .hist-elo { font-size: 0.75em; color: var(--success); text-align: center; margin-top: 5px; font-weight: bold; }
        
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üè∏ GI·∫¢I C·∫¶U L√îNG AO L√ÄNG</h1>
        <p>Khu V∆∞·ªùn Nh·ªè - Rank & Th√†nh T·ª±u</p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('ranking')">X·∫øp H·∫°ng</div>
        <div class="tab" onclick="switchTab('match')">Ghi Tr·∫≠n</div>
        <div class="tab" onclick="switchTab('history')">L·ªãch S·ª≠</div>
        <div class="tab" onclick="switchTab('add')">VƒêV M·ªõi</div>
    </div>

    <div id="ranking" class="tab-content active"><div id="playerList">ƒêang t·∫£i...</div></div>
    
    <div id="match" class="tab-content">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button onclick="setMode('singles')" id="btnS" style="background:var(--s); color:white">ƒê∆°n</button>
            <button onclick="setMode('doubles')" id="btnD" style="background:#ccc; color:white">ƒê√¥i</button>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1">
                <select id="t1p1" class="p-select"></select>
                <select id="t1p2" class="p-select" style="display:none"></select>
                <input type="number" id="s1" value="21">
            </div>
            <div style="flex:1">
                <select id="t2p1" class="p-select"></select>
                <select id="t2p2" class="p-select" style="display:none"></select>
                <input type="number" id="s2" value="0">
            </div>
        </div>
        <button onclick="recordMatch()" style="background:var(--p); color:white; font-weight:bold;">L∆∞u Tr·∫≠n ƒê·∫•u</button>
    </div>

    <div id="history" class="tab-content"><div id="matchHistory">ƒêang t·∫£i...</div></div>
    
    <div id="add" class="tab-content">
        <input type="text" id="newName" placeholder="T√™n VƒêV...">
        <button onclick="addPlayer()" style="background:var(--success); color:white; font-weight:bold;">ƒêƒÉng K√Ω</button>
    </div>
</div>

<div id="achModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2 id="modalName">VƒêV</h2>
        <div id="modalRankInfo" style="margin-bottom:10px;">Rank: -</div>
        <div class="bar-container"><div id="achBar" class="bar-fill" style="width:0%"></div></div>
        <p id="achText" style="font-size:0.9em; font-weight:bold; text-align:center; margin-bottom:15px;">0/27 th√†nh t·ª±u</p>
        <div id="achGridContainer"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwiza-0HCTzp2LjXz0nWvu4PRdhD10E-LHvdosq_3OVa5XkZGVDLQ0w2_3w6mcpTLEf/exec';
    let globalPlayers = [];
    let currentMode = 'singles';

    window.onload = connect;

    async function connect() {
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getPlayers`);
            const json = await res.json();
            if(json.status === "success") {
                globalPlayers = json.data;
                renderRanking();
                renderSelects();
            }
        } catch(e) {
            console.error("Connection error:", e);
            document.getElementById('playerList').innerHTML = '<p style="text-align:center; color:red; padding:20px;">‚ùå L·ªói k·∫øt n·ªëi!</p>';
        }
    }

    function getRankInfo(elo) {
        if (elo >= 2400) return {n: 'Huy·ªÅn Tho·∫°i', bg: 'bg-legend', g: 'group-legend', ic: 'üèÜ'};
        if (elo >= 2100) return {n: 'ƒê·∫°i Cao Th·ªß', bg: 'bg-grandmaster', g: 'group-grandmaster', ic: 'üëë'};
        if (elo >= 1800) return {n: 'Cao Th·ªß', bg: 'bg-master', g: 'group-master', ic: 'üîÆ'};
        if (elo >= 1500) return {n: 'Kim C∆∞∆°ng', bg: 'bg-diamond', ic: 'üí†'};
        if (elo >= 1200) return {n: 'B·∫°ch Kim', bg: 'bg-platinum', ic: 'üíé'};
        return {n: 'V√†ng', bg: 'bg-gold', ic: 'üü°'};
    }

    function renderRanking() {
        const tiers = [2400, 2100, 1800, 1500, 1200, 0];
        let html = "";
        const sorted = [...globalPlayers].sort((a,b) => b[2] - a[2]);
        tiers.forEach((minElo, idx) => {
            const info = getRankInfo(minElo);
            const playersInTier = sorted.filter(p => {
                if (idx === 0) return p[2] >= minElo;
                return p[2] >= minElo && p[2] < tiers[idx-1];
            });
            html += `
            <div class="rank-group ${info.g || ''}">
                <div class="rank-group-header ${info.bg}"><span>${info.ic} ${info.n}</span><span>${playersInTier.length} VƒêV</span></div>
                ${playersInTier.length > 0 ? playersInTier.map(p => `
                    <div class="player-row">
                        <div class="player-info-left">
                            <span class="player-name"><b>${p[1]}</b></span>
                            <button class="view-ach-btn" onclick="openAchievements('${p[0]}')">üèÜ Th√†nh t·ª±u</button>
                        </div>
                        <span class="player-elo">${p[2]} ELO</span>
                    </div>`).join('') : '<div style="padding:10px; text-align:center; color:#ccc;">Tr·ªëng...</div>'}
            </div>`;
        });
        document.getElementById('playerList').innerHTML = html;
    }

    async function openAchievements(id) {
        const modal = document.getElementById('achModal');
        modal.style.display = "block";
        
        const p = globalPlayers.find(x => x[0] == id);
        if (!p) {
            alert("‚ùå L·ªói!");
            modal.style.display = "none";
            return;
        }
        
        const rInfo = getRankInfo(p[2]);
        document.getElementById('modalName').innerText = p[1];
        document.getElementById('modalRankInfo').innerText = `${rInfo.ic} ${rInfo.n} - ${p[2]} ELO`;
        document.getElementById('achGridContainer').innerHTML = '<p style="text-align:center; padding:20px;">üîÑ ƒêang t·∫£i...</p>';
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getPlayerStats&playerId=${id}`);
            const json = await res.json();
            
            const s = json.stats || {
                wins: p[4] || 0,
                maxStreak: 0,
                morningGames: 0,
                nightGames: 0,
                comebacks: 0,
                giantKills: 0,
                uniqueOpponents: 0,
                isFirst: false
            };
            
            const totalMatches = p[3] || 1;
            const winRate = s.wins / totalMatches;
            
            // ‚úÖ X√ÅC ƒê·ªäNH RANK HI·ªÜN T·∫†I (ch·ªâ 1 rank s√°ng)
            const currentRankElo = p[2];
            let currentRankName = '';
            if (currentRankElo >= 2400) currentRankName = 'Huy·ªÅn Tho·∫°i';
            else if (currentRankElo >= 2100) currentRankName = 'ƒê·∫°i Cao Th·ªß';
            else if (currentRankElo >= 1800) currentRankName = 'Cao Th·ªß';
            else if (currentRankElo >= 1500) currentRankName = 'Kim C∆∞∆°ng';
            else if (currentRankElo >= 1200) currentRankName = 'B·∫°ch Kim';
            else currentRankName = 'V√†ng';
            
            const cats = [
                { t: 'üî• CHI·∫æN TH·∫ÆNG', a: [
                    {n:'First Blood', i:'ü•á', v: s.wins >= 1, d:'Th·∫Øng tr·∫≠n ƒë·∫ßu ti√™n'},
                    {n:'Hot Streak', i:'üî•', v: (s.maxStreak||0) >= 3, d:'Th·∫Øng 3 tr·∫≠n li√™n ti·∫øp'},
                    {n:'On Fire', i:'‚ö°', v: (s.maxStreak||0) >= 5, d:'Th·∫Øng 5 tr·∫≠n li√™n ti·∫øp'},
                    {n:'Unstoppable', i:'üí•', v: (s.maxStreak||0) >= 10, d:'Th·∫Øng 10 tr·∫≠n li√™n ti·∫øp'},
                    {n:'Legendary', i:'üëë', v: (s.maxStreak||0) >= 20, d:'Th·∫Øng 20 tr·∫≠n li√™n ti·∫øp'},
                    {n:'Veteran', i:'üéñÔ∏è', v: s.wins >= 10, d:'Th·∫Øng 10 tr·∫≠n'},
                    {n:'Champion', i:'üèÖ', v: s.wins >= 25, d:'Th·∫Øng 25 tr·∫≠n'},
                    {n:'Legend', i:'üèÜ', v: s.wins >= 50, d:'Th·∫Øng 50 tr·∫≠n'}
                ]},
                { t: 'üìä TH·ªêNG K√ä', a: [
                    {n:'Giant Killer', i:'üòà', v: (s.giantKills||0) >= 1, d:'Th·∫Øng ng∆∞·ªùi cao h∆°n 300 ELO'},
                    {n:'Perfect 70', i:'üíØ', v: (winRate >= 0.7 && totalMatches >= 20), d:'T·ª∑ l·ªá th·∫Øng 70%+ (min 20 tr·∫≠n)'},
                    {n:'Consistent', i:'üìà', v: (winRate >= 0.6 && totalMatches >= 30), d:'T·ª∑ l·ªá th·∫Øng 60%+ (min 30 tr·∫≠n)'},
                    {n:'Grinder', i:'üí™', v: totalMatches >= 30, d:'Ch∆°i 30 tr·∫≠n'},
                    {n:'Warrior', i:'‚öîÔ∏è', v: totalMatches >= 50, d:'Ch∆°i 50 tr·∫≠n'},
                    {n:'Master', i:'ü•ã', v: totalMatches >= 100, d:'Ch∆°i 100 tr·∫≠n'}
                ]},
                { t: 'üëë RANK', a: [
                    {n:'V√†ng', i:'üü°', v: currentRankName === 'V√†ng', d:'1000-1200 ELO'},
                    {n:'B·∫°ch Kim', i:'üíé', v: currentRankName === 'B·∫°ch Kim', d:'1200-1500 ELO'},
                    {n:'Kim C∆∞∆°ng', i:'üí†', v: currentRankName === 'Kim C∆∞∆°ng', d:'1500-1800 ELO'},
                    {n:'Cao Th·ªß', i:'üîÆ', v: currentRankName === 'Cao Th·ªß', d:'1800-2100 ELO'},
                    {n:'ƒê·∫°i Cao Th·ªß', i:'üëë', v: currentRankName === 'ƒê·∫°i Cao Th·ªß', d:'2100-2400 ELO'},
                    {n:'Huy·ªÅn Tho·∫°i', i:'üèÜ', v: currentRankName === 'Huy·ªÅn Tho·∫°i', d:'2400+ ELO'}
                ]},
                { t: 'üåü ƒê·∫∂C BI·ªÜT', a: [
                    {n:'Comeback', i:'ü¶Ö', v: (s.comebacks||0) >= 1, d:'Th·∫Øng sau thua 3 tr·∫≠n li√™n ti·∫øp'},
                    {n:'Early Bird', i:'üåÖ', v: (s.morningGames||0) >= 5, d:'Ch∆°i 5 tr·∫≠n bu·ªïi s√°ng (5-9h)'},
                    {n:'Night Owl', i:'ü¶â', v: (s.nightGames||0) >= 5, d:'Ch∆°i 5 tr·∫≠n bu·ªïi t·ªëi (18-22h)'},
                    {n:'S·ªë 1', i:'üéñÔ∏è', v: s.isFirst === true, d:'VƒêV ƒë·∫ßu ti√™n c·ªßa gi·∫£i'},
                    {n:'Butterfly', i:'ü¶ã', v: (s.uniqueOpponents||0) >= 10, d:'ƒê·∫•u v·ªõi 10 ng∆∞·ªùi kh√°c nhau'}
                ]}
            ];

            let totalUnlocked = 0;
            const totalAch = cats.reduce((sum, cat) => sum + cat.a.length, 0);
            
            let html = "";
            cats.forEach(cat => {
                html += `<div style="background:#eee; padding:8px; border-radius:8px; margin-top:15px; font-size:0.85em; font-weight:bold;">${cat.t}</div><div class="ach-grid">`;
                cat.a.forEach(ach => {
                    if(ach.v) totalUnlocked++;
                    html += `
                    <div class="ach-card ${ach.v ? 'unlocked' : ''}">
                        <span class="ach-icon">${ach.i}</span>
                        <span class="ach-name">${ach.n}</span>
                        <span class="ach-desc">${ach.d}</span>
                    </div>`;
                });
                html += `</div>`;
            });

            const pct = Math.round((totalUnlocked / totalAch) * 100);
            document.getElementById('achBar').style.width = pct + "%";
            document.getElementById('achText').innerText = `${totalUnlocked}/${totalAch} (${pct}%)`;
            document.getElementById('achGridContainer').innerHTML = html;
            
        } catch(error) {
            document.getElementById('achGridContainer').innerHTML = `<p style="text-align:center; color:red; padding:20px;">‚ùå ${error.message}</p>`;
        }
    }

    async function loadHistory() {
        const div = document.getElementById('matchHistory');
        div.innerHTML = "üîÑ ƒêang t·∫£i...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getMatches`);
            const json = await res.json();
            if(json.status === "success" && json.data.length > 0) {
                div.innerHTML = json.data.reverse().map(m => {
                    const date = new Date(m[7]).toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                    const type = m[1] === 'singles' ? 'üè∏ ƒê∆°n' : 'üë• ƒê√¥i';
                    let score = String(m[4]).trim();
                    const scores = score.split('-');
                    const s1 = parseInt(scores[0]) || 0;
                    const s2 = parseInt(scores[1]) || 0;
                    const crown1 = s1 > s2 ? ' <span style="color:#FFD700;">üëë</span>' : '';
                    const crown2 = s2 > s1 ? ' <span style="color:#FFD700;">üëë</span>' : '';
                    return `
                    <div class="history-card">
                        <span class="hist-date">${date}</span>
                        <span class="hist-type">${type}</span>
                        <div class="hist-players">
                            <div class="team-name">${m[2]}${crown1}</div>
                            <div class="hist-score">${score}</div>
                            <div class="team-name" style="text-align:right">${crown2}${m[3]}</div>
                        </div>
                        <div class="hist-elo">¬±${m[5]} ELO</div>
                    </div>`;
                }).join('');
            } else {
                div.innerHTML = "<p style='text-align:center; color:#999; padding:20px;'>Ch∆∞a c√≥ tr·∫≠n n√†o</p>";
            }
        } catch(e) {
            div.innerHTML = "<p style='text-align:center; color:red; padding:20px;'>‚ùå L·ªói</p>";
        }
    }

    function closeModal() { document.getElementById('achModal').style.display = "none"; }
    function switchTab(id) {
        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(id).classList.add('active');
        if(id === 'history') loadHistory();
    }
    function setMode(m) {
        currentMode = m;
        document.getElementById('btnS').style.background = m === 'singles' ? 'var(--s)' : '#ccc';
        document.getElementById('btnD').style.background = m === 'doubles' ? 'var(--s)' : '#ccc';
        document.getElementById('t1p2').style.display = m === 'doubles' ? 'block' : 'none';
        document.getElementById('t2p2').style.display = m === 'doubles' ? 'block' : 'none';
    }
    function renderSelects() {
        const h = '<option value="">--VƒêV--</option>' + globalPlayers.map(p => `<option value="${p[0]}">${p[1]}</option>`).join('');
        document.querySelectorAll('.p-select').forEach(s => s.innerHTML = h);
    }
    async function recordMatch() {
        const p1 = document.getElementById('t1p1').value, p2 = document.getElementById('t1p2').value;
        const p3 = document.getElementById('t2p1').value, p4 = document.getElementById('t2p2').value;
        const s1 = parseInt(document.getElementById('s1').value), s2 = parseInt(document.getElementById('s2').value);
        const t1Ids = [p1, p2].filter(i => i), t2Ids = [p3, p4].filter(i => i);
        const d = { action: 'recordMatch', data: { type: currentMode, team1Ids: t1Ids, team2Ids: t2Ids, team1Names: t1Ids.map(id => globalPlayers.find(p => p[0] == id)[1]), team2Names: t2Ids.map(id => globalPlayers.find(p => p[0] == id)[1]), score: s1 + "-" + s2, eloChange: 20, winner: s1 > s2 ? 1 : 2 } };
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d)});
        alert("‚úÖ ƒê√£ l∆∞u!"); connect();
    }
    async function addPlayer() {
        const name = document.getElementById('newName').value.trim();
        if(!name) { alert("‚ùå Nh·∫≠p t√™n!"); return; }
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'addPlayer', data: { name: name }})});
        alert("‚úÖ ƒê√£ th√™m!"); document.getElementById('newName').value = ''; connect();
    }
</script>
</body>
</html>
