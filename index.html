<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè∏ Gi·∫£i Ao L√†ng Khu V∆∞·ªùn Nh·ªè üè∏- H·ªá Th·ªëng ELO & Th√†nh T·ª±u</title>
    <style>
        :root { --p: #667eea; --s: #764ba2; --success: #28a745; --gold: #FFD700; --legend: #FF1493; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 10px; color: #333; }
        .container { max-width: 650px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; text-align: center; }
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; padding: 15px 5px; text-align: center; cursor: pointer; border: none; font-weight: bold; color: #666; font-size: 0.85em; }
        .tab.active { background: white; color: var(--p); border-bottom: 3px solid var(--p); }
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        /* RANK STYLE */
        @keyframes legendGlow { 0% { box-shadow: 0 0 5px #ff0000; } 50% { box-shadow: 0 0 20px #ff0000; } 100% { box-shadow: 0 0 5px #ff0000; } }
        @keyframes gmGlow { 0% { box-shadow: 0 0 5px #ff1493; } 50% { box-shadow: 0 0 15px #ff1493; } 100% { box-shadow: 0 0 5px #ff1493; } }
        .rank-group { margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: #fff; border: 1px solid #eee; }
        .group-legend { border: 2px solid #ff0000; animation: legendGlow 2s infinite; }
        .group-grandmaster { border: 2px solid #ff1493; animation: gmGlow 2s infinite; }
        .rank-group-header { padding: 10px 15px; font-weight: bold; color: white; display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; font-size: 0.75em; letter-spacing: 1px; }
        .bg-legend { background: linear-gradient(90deg, #b30000, #ff0000, #b30000); }
        .bg-grandmaster { background: linear-gradient(90deg, #8B008B, #FF1493); }
        .bg-master { background: linear-gradient(90deg, #4B0082, #9370DB); }
        .bg-diamond { background: linear-gradient(90deg, #104E8B, #1E90FF); }
        .bg-platinum { background: linear-gradient(90deg, #2F4F4F, #4A9EAF); }
        .bg-gold { background: #daa520; }
        .player-row { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; align-items: center; }
        .view-ach-btn { background: none; border: 1px solid var(--p); color: var(--p); padding: 4px 10px; border-radius: 6px; font-size: 0.7em; cursor: pointer; margin-left: 10px; font-weight: bold; }

        /* L·ªäCH S·ª¨ CARD */
        .history-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--p); }
        .hist-date { font-size: 0.75em; color: #888; display: block; margin-bottom: 5px; }
        .hist-players { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .team-name { flex: 1; font-size: 0.9em; font-weight: 600; }
        .hist-score { background: var(--p); color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; min-width: 65px; text-align: center; }

        /* MODAL TH√ÄNH T·ª∞U */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; padding: 10px; }
        .modal-content { background: white; max-width: 550px; margin: 20px auto; border-radius: 20px; padding: 20px; position: relative; }
        .ach-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; }
        .ach-card { background: #fff; border: 1px solid #eee; padding: 10px 5px; border-radius: 10px; text-align: center; opacity: 0.3; filter: grayscale(1); transition: 0.3s; }
        .ach-card.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--gold); background: #fffdf0; box-shadow: 0 0 8px rgba(255,215,0,0.3); }
        .ach-icon { font-size: 1.8em; display: block; }
        .ach-name { font-size: 0.8em; font-weight: bold; display: block; }
        .ach-desc { font-size: 0.65em; color: #777; line-height: 1.2; }

        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üè∏ GI·∫¢I AO L√ÄNG PRO</h1>
        <p>Th·ª© h·∫°ng VƒêV & Th√†nh t·ª±u</p>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('ranking')">X·∫øp H·∫°ng</div>
        <div class="tab" onclick="switchTab('match')">Ghi Tr·∫≠n</div>
        <div class="tab" onclick="switchTab('history')">L·ªãch S·ª≠</div>
        <div class="tab" onclick="switchTab('add')">Th√†nh Vi√™n</div>
    </div>

    <div id="ranking" class="tab-content active"><div id="playerList">ƒêang t·∫£i...</div></div>

    <div id="match" class="tab-content">
        <div style="display:flex; gap:10px;">
            <button onclick="setMode('singles')" id="btnS" style="background:var(--s); color:white">ƒê∆°n</button>
            <button onclick="setMode('doubles')" id="btnD" style="background:#ccc; color:white">ƒê√¥i</button>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><select id="t1p1" class="p-select"></select><select id="t1p2" class="p-select" style="display:none"></select><input type="number" id="s1" value="21"></div>
            <div style="flex:1"><select id="t2p1" class="p-select"></select><select id="t2p2" class="p-select" style="display:none"></select><input type="number" id="s2" value="0"></div>
        </div>
        <button onclick="recordMatch()" style="background:var(--p); color:white; font-weight:bold;">L∆∞u K·∫øt Qu·∫£</button>
    </div>

    <div id="history" class="tab-content"><div id="matchHistory"></div></div>

    <div id="add" class="tab-content">
        <input type="text" id="newName" placeholder="Nh·∫≠p t√™n VƒêV...">
        <button onclick="addPlayer()" style="background:var(--success); color:white; font-weight:bold;">ƒêƒÉng K√Ω</button>
    </div>
</div>

<div id="achModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" style="position:absolute; right:20px; top:15px; font-size:30px; cursor:pointer; color:#999;">&times;</span>
        <h2 id="modalName">T√™n VƒêV</h2>
        <div id="modalRankInfo" style="font-weight:bold; font-size:0.9em; margin-bottom:15px;"></div>
        <div id="achGridContainer"></div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwiza-0HCTzp2LjXz0nWvu4PRdhD10E-LHvdosq_3OVa5XkZGVDLQ0w2_3w6mcpTLEf/exec';
    let globalPlayers = [];
    let currentMode = 'singles';

    window.onload = connect;

    async function connect() {
        const res = await fetch(`${SCRIPT_URL}?action=getPlayers`);
        const json = await res.json();
        if(json.status === "success") {
            globalPlayers = json.data;
            renderRanking();
            renderSelects();
        }
    }

    function switchTab(id) {
        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
        if(event) event.currentTarget.classList.add('active');
        document.getElementById(id).classList.add('active');
        if(id === 'history') loadHistory();
    }

    function getRankInfo(elo) {
        if (elo >= 2400) return {n: 'Huy·ªÅn Tho·∫°i', bg: 'bg-legend', g: 'group-legend', ic: 'üèÜ'};
        if (elo >= 2100) return {n: 'ƒê·∫°i Cao Th·ªß', bg: 'bg-grandmaster', g: 'group-grandmaster', ic: 'üëë'};
        if (elo >= 1800) return {n: 'Cao Th·ªß', bg: 'bg-master', g: 'group-master', ic: 'üîÆ'};
        if (elo >= 1500) return {n: 'Kim C∆∞∆°ng', bg: 'bg-diamond', ic: 'üí†'};
        if (elo >= 1200) return {n: 'B·∫°ch Kim', bg: 'bg-platinum', ic: 'üíé'};
        return {n: 'V√†ng', bg: 'bg-gold', ic: 'üü°'};
    }

    function renderRanking() {
        const tiers = [2400, 2100, 1800, 1500, 1200, 0];
        let html = "";
        const sorted = [...globalPlayers].sort((a,b) => b[2] - a[2]);
        tiers.forEach((minElo, idx) => {
            const info = getRankInfo(minElo);
            const playersInTier = sorted.filter(p => idx === 0 ? p[2] >= 2400 : p[2] >= minElo && p[2] < tiers[idx-1]);
            html += `<div class="rank-group ${info.g || ''}"><div class="rank-group-header ${info.bg}"><span>${info.ic} ${info.n}</span><span>${playersInTier.length} VƒêV</span></div>
                ${playersInTier.length > 0 ? playersInTier.map(p => `<div class="player-row"><div><b>${p[1]}</b> <button class="view-ach-btn" onclick="openAchievements('${p[0]}')">üèÜ Th√†nh t·ª±u</button></div><b style="color:var(--p)">${p[2]} ELO</b></div>`).join('') : '<div style="padding:10px; text-align:center; color:#ccc; font-size:0.8em">Ch∆∞a c√≥ ai</div>'}</div>`;
        });
        document.getElementById('playerList').innerHTML = html;
    }

    async function loadHistory() {
        const div = document.getElementById('matchHistory');
        div.innerHTML = "üîÑ ƒêang t·∫£i l·ªãch s·ª≠...";
        const res = await fetch(`${SCRIPT_URL}?action=getMatches`);
        const json = await res.json();
        if(json.status === "success" && json.data.length > 0) {
            div.innerHTML = json.data.reverse().map(m => {
                const date = new Date(m[7]).toLocaleString('vi-VN', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
                const score = String(m[4]);
                const s = score.split('-');
                const c1 = parseInt(s[0]) > parseInt(s[1]) ? ' <span style="color:#FFD700">üëë</span>' : '';
                const c2 = parseInt(s[1]) > parseInt(s[0]) ? ' <span style="color:#FFD700">üëë</span>' : '';
                return `<div class="history-card"><span class="hist-date">${date} | ${m[1] === 'singles' ? 'ƒê∆°n' : 'ƒê√¥i'}</span>
                    <div class="hist-players"><div class="team-name" style="text-align:left;">${m[2]}${c1}</div><div class="hist-score">${score}</div><div class="team-name" style="text-align:right;">${c2}${m[3]}</div></div>
                    <div style="text-align:center; font-size:0.75em; color:var(--success); margin-top:5px; font-weight:bold;">Bi·∫øn ƒë·ªông: ¬±${m[5]} ELO</div></div>`;
            }).join('');
        }
    }

    async function openAchievements(id) {
        const container = document.getElementById('achGridContainer');
        container.innerHTML = "üîÑ ƒêang t√≠nh to√°n...";
        document.getElementById('achModal').style.display = "block";
        const p = globalPlayers.find(x => x[0] == id);
        document.getElementById('modalName').innerText = "VƒêV: " + p[1];
        document.getElementById('modalRankInfo').innerText = `H·∫°ng: ${getRankInfo(p[2]).n} (${p[2]} ELO)`;

        const res = await fetch(`${SCRIPT_URL}?action=getPlayerStats&playerId=${id}`);
        const json = await res.json();
        const s = json.stats;

        const db = {
            win: [{n:'First Blood', i:'ü•á', d:'Th·∫Øng tr·∫≠n ƒë·∫ßu', v: s.wins >= 1}, {n:'Hot Streak', i:'üî•', d:'Th·∫Øng 3 li√™n ti·∫øp', v: s.maxStreak >= 3}, {n:'On Fire', i:'‚ö°', d:'Th·∫Øng 5 li√™n ti·∫øp', v: s.maxStreak >= 5}, {n:'Unstoppable', i:'üí•', d:'Th·∫Øng 10 li√™n ti·∫øp', v: s.maxStreak >= 10}, {n:'Legendary', i:'üëë', d:'Th·∫Øng 20 li√™n ti·∫øp', v: s.maxStreak >= 20}, {n:'Veteran', i:'üéñÔ∏è', d:'Th·∫Øng 10 tr·∫≠n', v: s.wins >= 10}, {n:'Champion', i:'üèÖ', d:'Th·∫Øng 25 tr·∫≠n', v: s.wins >= 25}, {n:'Legend', i:'üèÜ', d:'Th·∫Øng 50 tr·∫≠n', v: s.wins >= 50}],
            stats: [{n:'Giant Killer', i:'üòà', d:'Th·∫Øng ng∆∞·ªùi +300 ELO', v: s.giantKills >= 1}, {n:'Perfect 70', i:'üíØ', d:'Winrate 70% (20+ tr·∫≠n)', v: (s.wins/p[3] >= 0.7 && p[3] >= 20)}, {n:'Consistent', i:'üìà', d:'Winrate 60% (30+ tr·∫≠n)', v: (s.wins/p[3] >= 0.6 && p[3] >= 30)}, {n:'Grinder', i:'üí™', d:'Ch∆°i 30 tr·∫≠n', v: p[3] >= 30}, {n:'Warrior', i:'‚öîÔ∏è', d:'Ch∆°i 50 tr·∫≠n', v: p[3] >= 50}, {n:'Master', i:'ü•ã', d:'Ch∆°i 100 tr·∫≠n', v: p[3] >= 100}],
            rank: [{n:'V√†ng', i:'üü°', d:'ƒê·∫°t rank V√†ng', v: p[2] >= 1000}, {n:'B·∫°ch Kim', i:'üíé', d:'ƒê·∫°t rank B·∫°ch Kim', v: p[2] >= 1200}, {n:'Kim C∆∞∆°ng', i:'üí†', d:'ƒê·∫°t rank Kim C∆∞∆°ng', v: p[2] >= 1500}, {n:'Cao Th·ªß', i:'üîÆ', d:'ƒê·∫°t rank Cao Th·ªß', v: p[2] >= 1800}, {n:'ƒê·∫°i Cao Th·ªß', i:'üëë', d:'ƒê·∫°t rank ƒêCT', v: p[2] >= 2100}, {n:'Huy·ªÅn Tho·∫°i', i:'üèÜ', d:'ƒê·∫°t rank HT', v: p[2] >= 2400}],
            special: [{n:'Comeback', i:'ü¶Ö', d:'Th·∫Øng sau chu·ªói thua 3', v: s.comebacks >= 1}, {n:'Early Bird', i:'üåÖ', d:'5 tr·∫≠n s√°ng (6-9h)', v: s.morningGames >= 5}, {n:'Night Owl', i:'ü¶â', d:'5 tr·∫≠n t·ªëi (18-22h)', v: s.nightGames >= 5}, {n:'S·ªë 1', i:'üéñÔ∏è', d:'VƒêV ƒë·∫ßu ti√™n c·ªßa gi·∫£i', v: s.isFirst}, {n:'Butterfly', i:'ü¶ã', d:'ƒê√°nh v·ªõi 10 ng∆∞·ªùi kh√°c', v: s.uniqueOpponents >= 10}]
        };

        let html = "";
        const categories = [{t: 'üî• CHI·∫æN TH·∫ÆNG', d: db.win}, {t: 'üìä TH·ªêNG K√ä', d: db.stats}, {t: 'üëë C·∫§P B·∫¨C', d: db.rank}, {t: 'üåü ƒê·∫∂C BI·ªÜT', d: db.special}];
        categories.forEach(cat => {
            html += `<div style="background:#f0f0f0; padding:5px 10px; border-radius:5px; margin:15px 0 10px; font-size:0.8em; font-weight:bold;">${cat.t}</div><div class="ach-grid">`;
            cat.d.forEach(a => { html += `<div class="ach-card ${a.v ? 'unlocked' : ''}"><span class="ach-icon">${a.i}</span><span class="ach-name">${a.n}</span><span class="ach-desc">${a.d}</span></div>`; });
            html += `</div>`;
        });
        container.innerHTML = html;
    }

    function closeModal() { document.getElementById('achModal').style.display = "none"; }
    function setMode(m) { currentMode = m; document.getElementById('btnS').style.background = m==='singles'?'var(--s)':'#ccc'; document.getElementById('btnD').style.background = m==='doubles'?'var(--s)':'#ccc'; document.getElementById('t1p2').style.display = m==='doubles'?'block':'none'; document.getElementById('t2p2').style.display = m==='doubles'?'block':'none'; }
    function renderSelects() { const h = '<option value="">--VƒêV--</option>' + globalPlayers.map(p => `<option value="${p[0]}">${p[1]}</option>`).join(''); document.querySelectorAll('.p-select').forEach(s => s.innerHTML = h); }
    async function recordMatch() { /* Gi·ªØ nguy√™n logic POST c·ªßa b·∫°n */ }
    async function addPlayer() { /* Gi·ªØ nguy√™n logic POST c·ªßa b·∫°n */ }
</script>
</body>
</html>
